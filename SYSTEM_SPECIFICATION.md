# システム仕様書: Redmine Pivot Plugin

## 1. 概要
本プラグインは、Redmineのチケットデータをピボットテーブル形式で表示・集計・分析するための機能を提供します。[Pivottable.js](https://pivottable.js.org/) をベースとし、ドラッグ＆ドロップによる直感的な操作、サーバー側への設定保存、Redmine固有フィールドの適切なハンドリングを特徴とします。

## 2. システム構成

### 2.1 アーキテクチャ概要
一般的なRedmineプラグインの構成（MVCモデル）に従います。

- **Model**: `IssueQuery` を拡張し、ピボットテーブルの設定情報 (`pivot_config`) を保持します。
- **View**: `pivot/index.html.erb` がメインのUIを提供し、必要なJavaScriptライブラリを読み込みます。
- **Controller**: `PivotController` がチケットデータの取得、JSON形式への変換、設定の保存処理を担当します。
- **Frontend**: `pivot.js` がPivottable.jsの初期化、データ加工（派生属性の生成）、UIインタラクション（設定保存、正規表現グループ化など）を制御します。

### 2.2 外部依存ライブラリ (CDN経由)
以下のライブラリを使用しています。
- **jQuery UI**: ドラッグ＆ドロップ機能 (v1.11.4)
- **Pivottable.js**: ピボットテーブルのコア機能 (v2.23.0)
- **D3.js**: チャート描画の基盤 (v5.16.0)
- **C3.js**: チャート描画 (v0.7.20)

## 3. 機能要件

### 3.1 ピボットテーブル表示
- **データソース**: プロジェクト内の全チケット、または指定されたカスタムクエリに基づくチケット。
- **フィールド**:
    - 標準フィールド: ID, 件名, トラッカー, ステータス, 優先度, 作成者, 担当者, カテゴリ, 対象バージョン, 開始日, 期日, 進捗率, 予定工数。
    - カスタムフィールド: プロジェクトで使用されている全カスタムフィールドを含みます。
- **集計方法 (Aggregators)**: 日本語化された集計関数を提供（件数, 合計, 平均, 割合など）。
    - 数値集計（合計、平均など）は、数値型フィールド（予定工数、数値型カスタムフィールド）のみが選択可能になるよう制御されます。

### 3.2 軸の自動生成と加工
- **日付フィールドの分解**:
    - 「開始日」「期日」および日付型カスタムフィールドに対し、自動的に「年」「月」「日」「年月」の派生属性を生成します。
- **正規表現によるテキストグループ化**:
    - ユーザーが任意のテキストフィールドに対して正規表現ルールを定義し、抽出結果を新たな集計軸として追加できます。
    - 設定項目: 対象フィールド、正規表現、フォーマット、グループ名。

### 3.3 設定の永続化
- **保存機能**:
    - 現在のピボットテーブルの状態（行・列・値の配置、集計方法、チャート種類、フィルタ状態、非表示項目、正規表現ルール）をサーバーに保存できます。
    - 保存は `IssueQuery` モデルのレコードとして扱われ、`pivot_config` カラムにJSON形式で格納されます。
- **ロード機能**:
    - 保存されたクエリIDを指定してアクセスすると、設定が復元されます。

### 3.4 チャート表示
- **基本チャート**: 棒グラフ, 折れ線グラフ, 散布図など（Pivottable.js標準）。


### 3.5 その他の機能
- **フィールド表示切替**: 不要なフィールドをチェックボックスで一括表示/非表示に設定可能。
- **フルスクリーンモード**: ピボットテーブル画面を最大化表示。
- **複数項目集計モード**: 複数のブール型（Yes/No）フィールドを横断して「Yes」の数を集計するアンケート集計のようなモードを提供。

## 4. データモデル / データベース

### 4.1 テーブル拡張
既存の `queries` テーブルにカラムを追加しています。

| テーブル名 | カラム名 | 型 | 説明 |
| :--- | :--- | :--- | :--- |
| `queries` | `pivot_config` | `text` | ピボットテーブルの設定JSONを格納 |

### 4.2 拡張モデル
`IssueQuery` モデルに対し、`RedminePivot::Patches::IssueQueryPatch` を適用して `pivot_config` を `safe_attributes` に追加しています。

## 5. インターフェース仕様

### 5.1 ルーティング
| メソッド | パス | コントローラー#アクション | 説明 |
| :--- | :--- | :--- | :--- |
| GET | `/projects/:project_id/pivot` | `pivot#index` | ピボットテーブル画面の表示 |
| POST | `/projects/:project_id/pivot/save` | `pivot#save` | 設定の保存（新規クエリ作成） |

### 5.2 権限 (Access Control)
- `view_pivot`: ピボットテーブルの閲覧および保存権限。

## 6. セキュリティ
- **権限チェック**: `before_action :authorize` により、Redmineの標準権限システムを利用してアクセス制御を行っています。
- **可視性**: 保存されたクエリは `VISIBILITY_PRIVATE` （作成者のみが閲覧可能）として保存されます（`PivotController#save`）。

## 7. 将来の拡張性 / 制約事項
- 現在、保存された設定は「非公開クエリ」としてのみ保存されます。共有クエリとしての保存機能はUI上に存在しません。
- 外部CDNに依存しているため、イントラネット環境でインターネット接続がない場合は、アセットをローカルに配置する改修が必要です。
