<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'pivot', :plugin => 'redmine_pivot' %>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.css">
  
  <!-- Ensure jQuery and jQuery UI are available. Redmine usually bundles jQuery. -->
  <!-- We might need to load jQuery UI if Redmine doesn't default to it for all pages, specifically for drag and drop -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
  
  <!-- D3 and C3 for charts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/c3_renderers.min.js"></script>
  <%= javascript_include_tag 'pivot', :plugin => 'redmine_pivot' %>
<% end %>

<% content_for :sidebar do %>
  <h3><%= l(:label_query_plural) %></h3>
  <ul class="queries">
    <li>
      <%= link_to l(:label_issue_plural), { :controller => 'pivot', :action => 'index', :project_id => @project }, :class => (@query.new_record? ? 'selected' : nil) %>
    </li>
    <% @sidebar_queries.each do |query| %>
      <li>
        <%= link_to query.name, { :controller => 'pivot', :action => 'index', :project_id => @project, :query_id => query.id }, :class => (@query.id == query.id ? 'selected' : nil) %>
      </li>
    <% end %>
  </ul>
<% end %>

<h2><%= l(:label_pivot) %></h2>


<div id="pivot-controls" style="margin-bottom: 20px; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9;">
  <div style="cursor: pointer; font-weight: bold;" onclick="$('#field-selection-area').toggle();">
    <span class="icon icon-settings"><%= l(:label_settings) %> (<%= l(:button_configure) %>)</span>
    <span id="field-toggle-icon" style="float: right;">â–¼</span>
  </div>
  <div style="margin-top: 5px; text-align: right;">
      <button type="button" id="fullscreen-toggle" style="font-size: 0.9em;"><%= l(:button_fullscreen) %></button>
      <button type="button" id="text-grouping-btn" style="font-size: 0.9em; margin-left: 10px;"><%= l(:button_text_grouping) %></button>
      <button type="button" id="save-query-btn" style="font-size: 0.9em; margin-left: 10px;"><%= l(:button_save) %></button>
  </div>
  
  <div id="text-grouping-modal" title="<%= l(:label_text_grouping_settings) %>" style="display:none;">
    <div style="margin-bottom: 15px;">
        <label><%= l(:label_target_field) %>:</label>
        <select id="tg-field-select" style="width: 100%;"></select>
    </div>
    <div style="margin-bottom: 15px;">
        <label><%= l(:label_regex) %> <%= l(:label_regex_example) %>:</label>
        <input type="text" id="tg-regex-input" style="width: 100%;" placeholder="^(\d+)">
    </div>
    <div style="margin-bottom: 15px;">
        <label><%= l(:label_format) %> <%= l(:label_format_example) %>:</label>
        <input type="text" id="tg-format-input" style="width: 100%;" value="{0}*">
    </div>
    <div style="margin-bottom: 15px;">
        <label><%= l(:label_group_name) %>:</label>
        <input type="text" id="tg-name-input" style="width: 100%;" placeholder="<%= l(:placeholder_group_name) %>">
        <div style="text-align: right; margin-top: 5px;">
            <button type="button" id="tg-add-btn"><%= l(:button_add) %></button>
        </div>
    </div>
    <hr>
    <div id="tg-active-rules" style="max-height: 200px; overflow-y: auto;">
        <!-- Rules will be listed here -->
    </div>
  </div>
  
  <%= form_tag({:controller => 'pivot', :action => 'save', :project_id => @project}, :id => 'save-query-form', :style => 'display:none;') do %>
    <%= hidden_field_tag 'query_name' %>
    <%= hidden_field_tag 'pivot_config' %>
  <% end %>

  <div id="field-selection-area" style="display: none; margin-top: 10px;">
    <div style="margin-bottom: 10px;">
      <button type="button" id="select-all-fields"><%= l(:button_check_all) %></button>
      <button type="button" id="deselect-all-fields"><%= l(:button_uncheck_all) %></button>
      <button type="button" id="apply-fields" style="font-weight: bold; margin-left: 20px;"><%= l(:button_apply) %></button>
    </div>
    <div id="field-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 5px;">
      <!-- Checkboxes will be generated here -->
    </div>
  </div>
</div>

<div id="pivot-table-output"></div>

<script>
  // Expose data to global scope
  window.redminePivotData = <%= raw @issues_json.to_json %>;
  
  // Default configuration with localized field names


  window.redminePivotOptions = {
    rows: ["<%= l(:field_tracker) %>", "<%= l(:field_status) %>"],
    cols: ["<%= l(:field_priority) %>"]
  };
  
  // Localized strings for JS
  window.redminePivotLocaleStrings = {
    fullScreen: "<%= l(:button_fullscreen) %>",
    exitFullScreen: "<%= l(:button_exit_fullscreen) %>",
    renderError: "<%= l('js.render_error') %>",
    computeError: "<%= l('js.compute_error') %>",
    uiRenderError: "<%= l('js.ui_render_error') %>",
    selectAll: "<%= l('js.select_all') %>",
    selectNone: "<%= l('js.select_none') %>",
    tooMany: "<%= l('js.too_many') %>",
    filterResults: "<%= l('js.filter_results') %>",
    apply: "<%= l('js.apply') %>",
    cancel: "<%= l('js.cancel') %>",
    totals: "<%= l('js.totals') %>",
    vs: "<%= l('js.vs') %>",
    by: "<%= l('js.by') %>",
    promptSaveSettings: "<%= l('js.prompt_save_settings') %>",
    alertNoBoolean: "<%= l('js.alert_no_boolean') %>",
    confirmMultiBoolean: "<%= l('js.confirm_multi_bool') %>",
    buttonMultiBoolean: "<%= l('js.button_multi_bool') %>",
    labelNoRules: "<%= l('js.label_no_rules') %>",
    errorFillAll: "<%= l('js.error_fill_all') %>",
    errorInvalidRegex: "<%= l('js.error_invalid_regex') %>",
    labelItemName: "<%= l('js.label_item_name') %>",
    labelValue: "<%= l('js.label_value') %>",
    labelYear: "<%= l('js.label_year') %>",
    labelMonth: "<%= l('js.label_month') %>",
    labelDay: "<%= l('js.label_day') %>",
    labelYearMonth: "<%= l('js.label_year_month') %>",
    buttonClose: "<%= l(:button_close) %>",
    aggregators: {
      count: "<%= l('js.aggregator_count') %>",
      countUniqueValues: "<%= l('js.aggregator_count_unique_values') %>",
      listUniqueValues: "<%= l('js.aggregator_list_unique_values') %>",
      sum: "<%= l('js.aggregator_sum') %>",
      integerSum: "<%= l('js.aggregator_integer_sum') %>",
      average: "<%= l('js.aggregator_average') %>",
      median: "<%= l('js.aggregator_median') %>",
      variance: "<%= l('js.aggregator_variance') %>",
      sampleVariance: "<%= l('js.aggregator_sample_variance') %>",
      standardDeviation: "<%= l('js.aggregator_standard_deviation') %>",
      sampleStandardDeviation: "<%= l('js.aggregator_sample_standard_deviation') %>",
      minimum: "<%= l('js.aggregator_minimum') %>",
      maximum: "<%= l('js.aggregator_maximum') %>",
      first: "<%= l('js.aggregator_first') %>",
      last: "<%= l('js.aggregator_last') %>",
      sumAsFractionOfTotal: "<%= l('js.aggregator_sum_as_fraction_of_total') %>",
      sumAsFractionOfRows: "<%= l('js.aggregator_sum_as_fraction_of_rows') %>",
      sumAsFractionOfColumns: "<%= l('js.aggregator_sum_as_fraction_of_columns') %>",
      countAsFractionOfTotal: "<%= l('js.aggregator_count_as_fraction_of_total') %>",
      countAsFractionOfRows: "<%= l('js.aggregator_count_as_fraction_of_rows') %>",
      countAsFractionOfColumns: "<%= l('js.aggregator_count_as_fraction_of_columns') %>"
    },
    renderers: {
      table: "<%= l('js.renderers.table', :default => 'Table') %>",
      tableBarchart: "<%= l('js.renderers.table_barchart', :default => 'Table Barchart') %>",
      heatmap: "<%= l('js.renderers.heatmap', :default => 'Heatmap') %>",
      rowHeatmap: "<%= l('js.renderers.row_heatmap', :default => 'Row Heatmap') %>",
      colHeatmap: "<%= l('js.renderers.col_heatmap', :default => 'Col Heatmap') %>",
      lineChart: "<%= l('js.renderers.line_chart', :default => 'Line Chart') %>",
      barChart: "<%= l('js.renderers.bar_chart', :default => 'Bar Chart') %>",
      stackedBarChart: "<%= l('js.renderers.stacked_bar_chart', :default => 'Stacked Bar Chart') %>",
      areaChart: "<%= l('js.renderers.area_chart', :default => 'Area Chart') %>",
      scatterChart: "<%= l('js.renderers.scatter_chart', :default => 'Scatter Chart') %>",
      tsvExport: "<%= l('js.renderers.tsv_export', :default => 'TSV Export') %>"
    }
  };
  
  // Date fields metadata
  window.redminePivotDateFields = <%= raw @date_fields.to_json %>;
  
  // Numeric fields metadata (for restricting aggregators)
  window.redminePivotNumericFields = <%= raw @numeric_fields.to_json %>;

  // Boolean fields metadata (for multi-column aggregation)
  window.redminePivotBooleanFields = <%= raw @boolean_fields.to_json %>;

  // Saved configuration from server
  window.redminePivotQueryConfig = <%= raw @pivot_config.to_json %>;
</script>
