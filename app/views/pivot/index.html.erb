<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'jquery-ui.min', :plugin => 'redmine_pivot' %>
  <%= stylesheet_link_tag 'pivot.min', :plugin => 'redmine_pivot' %>
  <%= stylesheet_link_tag 'c3.min', :plugin => 'redmine_pivot' %>
  <%= stylesheet_link_tag 'pivot', :plugin => 'redmine_pivot' %>

  <%= javascript_include_tag 'jquery-ui.min', :plugin => 'redmine_pivot' %>
  <%= javascript_include_tag 'd3.min', :plugin => 'redmine_pivot' %>
  <%= javascript_include_tag 'c3.min', :plugin => 'redmine_pivot' %>
  <%= javascript_include_tag 'pivot.min', :plugin => 'redmine_pivot' %>
  <%= javascript_include_tag 'c3_renderers.min', :plugin => 'redmine_pivot' %>
  <%= javascript_include_tag 'pivot', :plugin => 'redmine_pivot' %>
<% end %>

<% content_for :sidebar do %>
  <h3><%= l(:label_query_plural) %></h3>
  <ul class="queries">
    <li>
      <%= link_to l(:label_issue_plural), { :controller => 'pivot', :action => 'index', :project_id => @project }, :class => (@query.new_record? ? 'selected' : nil) %>
    </li>
    <% @sidebar_queries.each do |query| %>
      <li>
        <%= link_to query.name, { :controller => 'pivot', :action => 'index', :project_id => @project, :query_id => query.id }, :class => (@query.id == query.id ? 'selected' : nil) %>
      </li>
    <% end %>
  </ul>
<% end %>

<h2><%= l(:label_pivot) %></h2>


<fieldset class="collapsible collapsed">
  <legend onclick="toggleFieldset(this);" class="icon icon-collapsed"><%= l(:label_settings) %></legend>
  <div style="display: none;">
    <div class="pivot-controls-container">
      <div class="pivot-buttons-area">
          <button type="button" id="fullscreen-toggle" class="pivot-button"><%= l(:button_fullscreen) %></button>
          <button type="button" id="text-grouping-btn" class="pivot-button pivot-button-spacer"><%= l(:button_text_grouping) %></button>
          <button type="button" id="save-query-btn" class="pivot-button pivot-button-spacer"><%= l(:button_save) %></button>
      </div>
      
      <div id="text-grouping-modal" title="<%= l(:label_text_grouping_settings) %>" style="display:none;">
        <div class="pivot-setting-row">
            <label><%= l(:label_target_field) %>:</label>
            <select id="tg-field-select" class="pivot-width-full"></select>
        </div>
        <div class="pivot-setting-row">
            <label><%= l(:label_regex) %> <%= l(:label_regex_example) %>:</label>
            <input type="text" id="tg-regex-input" class="pivot-width-full" placeholder="^(\d+)">
        </div>
        <div class="pivot-setting-row">
            <label><%= l(:label_format) %> <%= l(:label_format_example) %>:</label>
            <input type="text" id="tg-format-input" class="pivot-width-full" value="{0}*">
        </div>
        <div class="pivot-setting-row">
            <label><%= l(:label_group_name) %>:</label>
            <input type="text" id="tg-name-input" class="pivot-width-full" placeholder="<%= l(:placeholder_group_name) %>">
            <div class="pivot-modal-actions">
                <button type="button" id="tg-add-btn"><%= l(:button_add) %></button>
            </div>
        </div>
        <hr>
        <div id="tg-active-rules" class="pivot-rules-list">
            <!-- Rules will be listed here -->
        </div>
      </div>
      
      <%= form_tag({:controller => 'pivot', :action => 'save', :project_id => @project}, :id => 'save-query-form', :style => 'display:none;') do %>
        <%= hidden_field_tag 'query_name' %>
        <%= hidden_field_tag 'pivot_config' %>
      <% end %>

      <div id="field-selection-area" class="field-selection-area" style="display: block;">
        <div class="field-buttons-area">
          <button type="button" id="select-all-fields"><%= l(:button_check_all) %></button>
          <button type="button" id="deselect-all-fields"><%= l(:button_uncheck_all) %></button>
          <button type="button" id="apply-fields" class="apply-button"><%= l(:button_apply) %></button>
        </div>
        <div id="field-checkboxes" class="field-checkboxes-grid">
          <!-- Checkboxes will be generated here -->
        </div>
      </div>
    </div>
  </div>
</fieldset>

<div id="pivot-table-output"></div>

<script>
  // Consolidated configuration object
  window.redminePivotConfig = {
    data: <%= @issues_json.to_json.html_safe %>,
    options: <%= pivot_default_options.to_json.html_safe %>,
    localeStrings: <%= pivot_locale_data.to_json.html_safe %>,
    dateFields: <%= @date_fields.to_json.html_safe %>,
    numericFields: <%= @numeric_fields.to_json.html_safe %>,
    booleanFields: <%= @boolean_fields.to_json.html_safe %>,
    savedConfig: <%= @pivot_config.to_json.html_safe %>
  };
</script>
