<% content_for :header_tags do %>
  <link rel="stylesheet" href="<%= Redmine::Utils.relative_url_root %>/plugin_assets/redmine_pivot/stylesheets/jquery-ui.min.css">
  <link rel="stylesheet" href="<%= Redmine::Utils.relative_url_root %>/plugin_assets/redmine_pivot/stylesheets/pivot.min.css">
  <link rel="stylesheet" href="<%= Redmine::Utils.relative_url_root %>/plugin_assets/redmine_pivot/stylesheets/c3.min.css">
  <link rel="stylesheet" href="<%= Redmine::Utils.relative_url_root %>/plugin_assets/redmine_pivot/stylesheets/pivot.css">

  <script src="<%= Redmine::Utils.relative_url_root %>/plugin_assets/redmine_pivot/javascripts/jquery-ui.min.js"></script>
  <script src="<%= Redmine::Utils.relative_url_root %>/plugin_assets/redmine_pivot/javascripts/d3.min.js"></script>
  <script src="<%= Redmine::Utils.relative_url_root %>/plugin_assets/redmine_pivot/javascripts/c3.min.js"></script>
  <script src="<%= Redmine::Utils.relative_url_root %>/plugin_assets/redmine_pivot/javascripts/pivot.min.js"></script>
  <script src="<%= Redmine::Utils.relative_url_root %>/plugin_assets/redmine_pivot/javascripts/c3_renderers.min.js"></script>
  <script src="<%= Redmine::Utils.relative_url_root %>/plugin_assets/redmine_pivot/javascripts/pivot.js"></script>
<% end %>

<% content_for :sidebar do %>
  <h3><%= l(:label_query_plural) %></h3>
  <ul class="queries">
    <li>
      <%= link_to l(:label_issue_plural), { :controller => 'pivot', :action => 'index', :project_id => @project }, :class => (@query.new_record? ? 'selected' : nil) %>
    </li>
    <% @sidebar_queries.each do |query| %>
      <li>
        <%= link_to query.name, { :controller => 'pivot', :action => 'index', :project_id => @project, :query_id => query.id }, :class => (@query.id == query.id ? 'selected' : nil) %>
      </li>
    <% end %>
  </ul>
<% end %>

<h2><%= l(:label_pivot) %></h2>


<div id="pivot-controls" style="margin-bottom: 20px; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9;">
  <div style="cursor: pointer; font-weight: bold;" onclick="$('#field-selection-area').toggle();">
    <span class="icon icon-settings"><%= l(:label_settings) %> (<%= l(:button_configure) %>)</span>
    <span id="field-toggle-icon" style="float: right;">â–¼</span>
  </div>
  <div style="margin-top: 5px; text-align: right;">
      <button type="button" id="fullscreen-toggle" style="font-size: 0.9em;"><%= l(:button_fullscreen) %></button>
      <button type="button" id="text-grouping-btn" style="font-size: 0.9em; margin-left: 10px;"><%= l(:button_text_grouping) %></button>
      <button type="button" id="save-query-btn" style="font-size: 0.9em; margin-left: 10px;"><%= l(:button_save) %></button>
  </div>
  
  <div id="text-grouping-modal" title="<%= l(:label_text_grouping_settings) %>" style="display:none;">
    <div style="margin-bottom: 15px;">
        <label><%= l(:label_target_field) %>:</label>
        <select id="tg-field-select" style="width: 100%;"></select>
    </div>
    <div style="margin-bottom: 15px;">
        <label><%= l(:label_regex) %> <%= l(:label_regex_example) %>:</label>
        <input type="text" id="tg-regex-input" style="width: 100%;" placeholder="^(\d+)">
    </div>
    <div style="margin-bottom: 15px;">
        <label><%= l(:label_format) %> <%= l(:label_format_example) %>:</label>
        <input type="text" id="tg-format-input" style="width: 100%;" value="{0}*">
    </div>
    <div style="margin-bottom: 15px;">
        <label><%= l(:label_group_name) %>:</label>
        <input type="text" id="tg-name-input" style="width: 100%;" placeholder="<%= l(:placeholder_group_name) %>">
        <div style="text-align: right; margin-top: 5px;">
            <button type="button" id="tg-add-btn"><%= l(:button_add) %></button>
        </div>
    </div>
    <hr>
    <div id="tg-active-rules" style="max-height: 200px; overflow-y: auto;">
        <!-- Rules will be listed here -->
    </div>
  </div>
  
  <%= form_tag({:controller => 'pivot', :action => 'save', :project_id => @project}, :id => 'save-query-form', :style => 'display:none;') do %>
    <%= hidden_field_tag 'query_name' %>
    <%= hidden_field_tag 'pivot_config' %>
  <% end %>

  <div id="field-selection-area" style="display: none; margin-top: 10px;">
    <div style="margin-bottom: 10px;">
      <button type="button" id="select-all-fields"><%= l(:button_check_all) %></button>
      <button type="button" id="deselect-all-fields"><%= l(:button_uncheck_all) %></button>
      <button type="button" id="apply-fields" style="font-weight: bold; margin-left: 20px;"><%= l(:button_apply) %></button>
    </div>
    <div id="field-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 5px;">
      <!-- Checkboxes will be generated here -->
    </div>
  </div>
</div>

<div id="pivot-table-output"></div>

<script>
  // Expose data to global scope
  window.redminePivotData = <%= @issues_json.to_json.html_safe %>;
  
  // Default configuration with localized field names


  window.redminePivotOptions = <%= pivot_default_options.to_json.html_safe %>;
  
  // Localized strings for JS
  window.redminePivotLocaleStrings = <%= pivot_locale_data.to_json.html_safe %>;
  
  // Date fields metadata
  window.redminePivotDateFields = <%= @date_fields.to_json.html_safe %>;
  
  // Numeric fields metadata (for restricting aggregators)
  window.redminePivotNumericFields = <%= @numeric_fields.to_json.html_safe %>;

  // Boolean fields metadata (for multi-column aggregation)
  window.redminePivotBooleanFields = <%= @boolean_fields.to_json.html_safe %>;

  // Saved configuration from server
  window.redminePivotQueryConfig = <%= @pivot_config.to_json.html_safe %>;
</script>
