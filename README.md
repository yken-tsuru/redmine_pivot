# Redmine Pivot Plugin

Redmineのチケットをピボットテーブル形式で表示・集計するプラグインです。
[Pivottable.js](https://pivottable.js.org/) を使用しており、ブラウザ上で直感的にクロス集計を行うことができます。

## 機能

- **チケットのクロス集計**: 標準フィールド（ステータス、優先度、担当者など）およびカスタムフィールドを行・列に自由に配置して集計できます。
- **ドラッグ＆ドロップ操作**: フィールドをマウス操作で移動させるだけで、集計軸を動的に変更できます。
- **パフォーマンス最適化**: 大量のチケットがある場合でも、カスタムフィールドの一括読み込み（Eager Loading）により高速にデータを取得します。
- **カスタムクエリ対応**: 保存済みのカスタムクエリを選択して、集計対象のチケットを絞り込むことができます。
- **日付の自動グループ化**: 開始日や期日、カスタムフィールド（日付型）から、自動的に「年」「月」「年月」などの集計軸を生成します。
- **正規表現によるテキストグループ化**: 任意のテキストフィールド（件名など）に対して正規表現を適用し、抽出した部分文字列に基づいて新たな集計軸を作成できます。これにより、命名規則に基づいたカテゴライズ集計が可能になります。

## インストール方法

1. Redmineの `plugins` ディレクトリに本プラグインを配置します。
   （ディレクトリ名は `redmine_pivot` としてください）
   ```bash
   cd /path/to/redmine/plugins
   git clone https://your-repository-url/redmine_pivot.git
   ```

2. Redmineを再起動します。

## 利用方法

### 1. モジュールの有効化
プラグインを使用したいプロジェクトの「設定」画面を開き、「モジュール」タブを選択します。
モジュール一覧の中にある **「Pivot（または ピボット）」** にチェックを入れ、「保存」をクリックします。
※ デフォルトでは有効になっている場合もあります。

### 2. ピボットテーブルの表示
プロジェクトメニュー（「概要」「チケット」などが並んでいる列）に追加された **「ピボット」** タブをクリックします。
チケットデータが読み込まれ、ピボットテーブルが表示されます。

### 3. チケットの絞り込み（カスタムクエリ）
画面右側のサイドバーに、保存済みの「カスタムクエリ」一覧が表示されます。
任意のクエリをクリックすると、そのクエリ条件に合致するチケットのみが集計対象として読み込まれます。
「すべてのチケット」をクリックすると、絞り込みが解除されます。

### 4. 集計の設定（Aggregators）
画面左上のプルダウンメニュー（初期値「件数」）から、集計方法（アグリゲーター）を変更できます。

| 集計方法 | 説明 | 利用シーン |
| :--- | :--- | :--- |
| **件数** | チケットの個数をカウントします（デフォルト）。 | ステータスごとのチケット数を知りたい場合など。 |
| **合計** | 指定した数値フィールドの値を合計します。 | 「予定工数」の合計や、数値型カスタムフィールド（例: 売上、コスト）の総和を求めたい場合。 |
| **平均** | 指定した数値フィールドの平均を算出します。 | チケットごとの平均工数などを分析する場合。 |
| **件数に対する割合** | 全体、行、列に対する割合（％）を表示します。 | 特定のトラッカーが全体の何割を占めるか等を見る場合。 |

**数値フィールドの選択方法**:
「合計」や「平均」を選択すると、その隣に新たなプルダウンメニューが表示されます。ここで集計対象としたい数値フィールド（例: `estimated_hours` や `数値リスト`）を選択してください。

### 5. 軸の操作
画面上部には利用可能なフィールド（ステータス、トラッカー、カスタムフィールド等）が並んでいます。

- **行の追加**: フィールドを行エリア（左側）にドラッグ＆ドロップします。
- **列の追加**: フィールドを列エリア（上部）にドラッグ＆ドロップします。
- **フィルタリング**: 各フィールド名の右側にある「▼」をクリックすると、表示する値を絞り込むことができます（例: 「終了」ステータスを除外する）。
- **フィールドの選択**: 画面上部の「設定 (表示項目の設定)」を開き、チェックボックスで表示したい項目を選択できます。不要な項目のチェックを外して「適用」すると、ピボットテーブル上から隠すことができます。
- **全画面表示**: 「全画面表示」ボタンをクリックすると、ピボットテーブルをブラウザ画面いっぱいに拡大表示できます。

### 6. グラフ表示
表形式だけでなく、棒グラフなどで表示することも可能です。左上のプルダウンメニュー（通常「表」となっている箇所）からチャートの種類を選択してください。

### 7. 正規表現によるテキストグループ化
テキスト形式のフィールド（件名、テキスト型カスタムフィールドなど）に対して正規表現を適用し、その結果を用いて新たな集計項目を作成することができます。

**手順**:
1. 画面右上の「正規表現グループ化」ボタンをクリックします。
2. 設定ダイアログが表示されるので、以下の項目を入力します。
    - **フィールド**: 対象とするテキストフィールドを選択します（例: 件名）。
    - **正規表現**: 抽出ルールを正規表現で記述します（例: `^\[(.*?)\]` で角括弧内のテキストを抽出）。
    - **フォーマット**: 抽出結果の表示形式を指定します（例: `$1` で1番目のキャプチャグループを使用）。
    - **新しいフィールド名**: ピボットテーブル上で表示される新しいフィールドの名前を入力します（例: カテゴリ）。
3. 「追加」ボタンをクリックすると、リストに設定が追加されます。「保存」で適用します。
4. ピボットテーブルのフィールド一覧に、作成した新しいフィールド（例: カテゴリ）が追加されます。これを行や列にドラッグ＆ドロップして集計に使用できます。

※ 設定はサーバーに保存され、次回以降も利用可能です。
